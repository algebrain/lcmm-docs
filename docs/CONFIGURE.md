# configure — руководство для разработчика (пользователя библиотеки)

Эта инструкция описывает, как использовать библиотеку `configure` в коде приложения. Прочитав её, можно корректно загрузить конфигурацию, применить типы, проверить обязательные ключи и безопасно выводить конфиг.

## Что делает библиотека

- Загружает TOML‑конфиг из файла (по явному пути или из дефолтных файлов в `cwd`).
- Накладывает переменные окружения поверх файла.
- Применяет валидацию обязательных ключей.
- Опционально приводит строки env к нужным типам.
- Позволяет безопасно вывести конфиг с маскированием секретов.

## Подключение

```clojure
(require '[configure.core :as cfg])
```

## Основной вызов

```clojure
(def config
  (cfg/load-config
   {:module-name "users"
    :config "./users_config.toml"
    :allow-relative? true
    :env-only? false
    :allowed-keys #{"db.url" "db.user" "db.port" "debug"}
    :required #{"db.url" "db.user"}
    :types {"db.port" :int "debug" :bool}
    :logger (fn [lvl data] (println lvl data))}))

(:config config)
```

### Параметры `load-config`

- `:module-name` — имя модуля (строка). Нужно для маппинга env‑переменных.
- `:config` — явный путь к TOML‑файлу. Если указан, файл обязателен.
- `:allow-relative?` — разрешать ли относительные пути для `:config` (по умолчанию `true`).
- `:env-only?` — если `true`, поиск дефолтных файлов отключается.
- `:allowed-keys` — набор разрешённых dot‑ключей из env. Остальные будут игнорироваться.
- `:required` — набор обязательных ключей. Если отсутствуют — ошибка.
- `:types` — карта типов для строковых значений env (`:int`, `:bool`, `:csv`).
- `:logger` — функция для логирования метаданных загрузки.

### Возвращаемое значение

`load-config` возвращает:

```clojure
{:config <map> :meta <map>}
```

`meta` содержит:
- `:file` — путь к использованному файлу (или `nil`).
- `:source` — `:explicit`, `:module-default`, `:global-default`, `:none`.
- `:env-keys` — список ключей, пришедших из env.

## Применение типов

Типы применяются только к строкам, пришедшим из env:

- `:int` — целое число
- `:bool` — `true` или `false`
- `:csv` — список через запятую

## Безопасный вывод

```clojure
(cfg/dump-config (:config config))
```

Можно передать свой предикат для определения секретных ключей:

```clojure
(cfg/dump-config (:config config)
                 {:secret-key? (fn [k] (re-find #"(?i)password|token" (str k)))})
```

## Ошибки и исключения

- Если `:module-name` пустой — выбрасывается исключение.
- Если `:config` задан, но файл не найден — исключение.
- Если `:allow-relative? false` и путь относительный — исключение.
- Если отсутствуют обязательные ключи из `:required` — исключение.

## Рекомендации

- В проде используйте `:env-only? true` или явный абсолютный `:config`.
- Ограничивайте env‑ключи через `:allowed-keys` для предсказуемости.
- Никогда не логируйте «сырой» конфиг — используйте `dump-config`.
