# configure — руководство для администратора (подготовка конфигурации)

Эта инструкция описывает, как подготовить корректную конфигурацию для библиотек, использующих `configure`: как устроены TOML‑файлы, как задавать переменные окружения и как работает приоритет источников.

## Источники конфигурации и порядок

1. TOML‑файл (явный путь `:config` или дефолтные файлы в `cwd`).
2. Переменные окружения — всегда применяются поверх файла.

Режимы в проде (задаются разработчиком в коде приложения, администратор их не настраивает напрямую):
- Приложение может быть запущено в режиме только env (в коде это флаг `:env-only? true`). Тогда файлов конфигурации нет.
- Либо используется явный путь к файлу через `:config` (обычно абсолютный путь), а env переопределяет значения поверх.

## Формат TOML

TOML может содержать секции; библиотека преобразует их в плоские dot‑ключи.

Пример TOML:

```toml
[db]
url = "jdbc:postgresql://localhost/app"
user = "app"
port = 5432

[http]
port = 8080
```

Итоговые ключи:
- `db.url`
- `db.user`
- `db.port`
- `http.port`

Ключи нормализуются к lower‑case.

## Переменные окружения

Шаблон имени:

```
MODULE__SECTION__KEY
```

Пример для модуля `users`:

- `USERS__DB__URL` → `db.url`
- `USERS__DB__PORT` → `db.port`

Пустые значения env (пустая строка) не переопределяют файл.

## Ограничение разрешённых ключей

Если в приложении задан `:allowed-keys`, то администратор должен использовать только эти ключи. Все остальные env‑переменные с префиксом модуля будут проигнорированы.

## Примеры сценариев

### 1. Env‑only
- Файлы отсутствуют.
- Заданы только переменные окружения.
- Приложение запускается с `:env-only? true`.

### 2. Явный файл + env
- Есть TOML по абсолютному пути.
- `:config` задан в приложении.
- Env может переопределять любые значения, если ключи разрешены.

## Рекомендации безопасности

- Не храните секреты в TOML, если есть возможность задать их через env.
- Не размещайте конфиги в общедоступных каталогах.
- Следите, чтобы ключи секретов явно назывались (`password`, `token`, `secret`) для корректного маскирования в логах.
