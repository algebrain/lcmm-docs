# Логирование и Наблюдаемость (Observability)

Этот документ описывает стандартный подход к логированию в системе, нацеленный на обеспечение наблюдаемости, упрощение отладки и анализа поведения компонентов. Ключевым принципом является использование структурированных логов в формате карт.
Имплементация шины событий доступна в [GitHub-репозитории](https://github.com/algebrain/lcmm-event-bus).

## 1. Стандартный Интерфейс Логгера

Логгер в системе представляет собой функцию, которая принимает два аргумента:
1.  `level` — уровень логирования (ключевое слово, например, `:info`, `:warn`, `:error`, `:debug`, `:trace`).
2.  `data` — **карта** с данными о событии, предоставляющая контекст.

### Пример реализации логгера
Вы можете реализовать логгер, который обертывает любую библиотеку логирования, например `clojure.tools.logging`:

```clojure
(require '[clojure.tools.logging :as log])

(defn make-app-logger []
  (fn [level data]
    (case level
      :info  (log/info data)
      :warn  (log/warn data)
      :error (log/error data)
      :debug (log/debug data)
      :trace (log/trace data)
      (log/info data))))) ; Дефолтный уровень
```

## 2. Интеграция Логгера в Компоненты

Каждый компонент или модуль системы, требующий логирования, должен принимать экземпляр этой функции-логгера в качестве зависимости.

Например:
*   **`event-bus`**: При создании экземпляра шины через `bus/make-bus` функция-логгер передается через опцию `:logger`.
*   **Модули**: Функция `init!` каждого модуля (см. `MODULE.md`) будет принимать логгер как одну из своих зависимостей, что позволит модулю логировать свои внутренние события.

## 3. Структура Лог-Сообщений

Все сообщения, передаваемые логгеру в аргументе `data`, **должны быть картами**. Это обеспечивает структурированность логов, упрощает их поиск, фильтрацию и анализ в системах агрегации логов.

Рекомендуемые поля для всех лог-сообщений:
*   `:component` (обязательно): Ключевое слово, идентифицирующее компонент, который сгенерировал лог (например, `:event-bus`, `:my-module`, `:user-service`).
*   `:event` (обязательно): Ключевое слово, кратко описывающее тип произошедшего события (например, `:event-published`, `:user-created`, `:http-request-received`).
*   Дополнительные поля: Любые другие данные, которые помогают понять контекст события (например, `correlation-id`, `user-id`, `path`, `exception`, `payload`).

## 4. Примеры Лог-Событий от `event-bus`

`event-bus` генерирует несколько типов структурированных событий, которые попадают в логгер. Эти примеры демонстрируют использование стандартного интерфейса логгера и рекомендуемой структуры лог-сообщений.

### `:event-published`
- **Уровень:** `:info`
- **Когда:** Генерируется каждый раз при вызове `bus/publish`.
- **Данные:** Содержит ключ `:component :event-bus` и полный `envelope` опубликованного сообщения.
- **Польза:** Позволяет увидеть абсолютно все события, проходящие через шину.

### `:schema-validation-failed`
- **Уровень:** `:warn`
- **Когда:** Если подписчик `event-bus` использует `:schema`, и полезная нагрузка (`payload`) не проходит валидацию.
- **Данные:** Содержит ключ `:component :event-bus`, `event-type`, `correlation-id`, `payload` и `:errors` с деталями ошибки валидации от `malli`.
- **Польза:** Помогает быстро выявлять компоненты, отправляющие данные в неверном формате.

### `:handler-failed`
- **Уровень:** `:error`
- **Когда:** Если во время выполнения функции-обработчика `event-bus` происходит исключение.
- **Данные:** Содержит ключ `:component :event-bus`, `:exception` с объектом исключения и другие метаданные события.
- **Польза:** Изолирует и сообщает об ошибках в подписчиках, не останавливая работу всей шины.

### `:buffer-full`
- **Уровень:** `:error`
- **Когда:** В режиме `:buffered` шины, если очередь событий переполнена и новое событие не может быть принято.
- **Данные:** Содержат ключ `:component :event-bus` и информацию о переполнении буфера.
- **Польза:** Сигнализирует о системной перегрузке (backpressure).

### `:bus-closing`, `:bus-closed`, `:shutdown-timeout`
- **Уровень:** `:info` или `:warn`
- **Когда:** Генерируются `event-bus` во время штатного завершения работы шины через `close`.
- **Данные:** Содержат ключ `:component :event-bus` и информацию о жизненном цикле шины.
