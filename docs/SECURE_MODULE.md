# SECURE_MODULE: безопасность на уровне модуля

Версия: `1.1-draft`

Этот документ описывает ответственность конкретного LCMM-модуля.
Модуль опирается на app-level защиту, но обязан соблюдать свои правила безопасности.

## 1. Термины (кратко)

1. `shape` — минимальная ожидаемая структура данных.
2. `allow-list` — список явно разрешенных значений.

## 2. Граница ответственности модуля

Модуль ОБЯЗАТЕЛЬНО:
1. валидирует свои входные структуры (после app-level валидации);
2. проверяет минимальную ожидаемую структуру (`shape`) `:auth/user` перед использованием;
3. не строит SQL через конкатенацию пользовательского ввода;
4. соблюдает единый error-contract;
5. не логирует секреты.

Модуль НЕ ДОЛЖЕН:
1. дублировать app-level проверку сессии;
2. внедрять собственный несовместимый формат ошибок;
3. обходить общие лимиты/политику redaction.

## 3. Валидация на уровне модуля

Даже если общая валидация уже есть, модуль проверяет доменные ограничения:
1. допустимые состояния сущности;
2. бизнес-инварианты;
3. связи между полями.

Пример:
1. дата окончания не раньше даты начала;
2. поле статуса только из allow-list.

Нарушение бизнес-валидации возвращает управляемую ошибку по error-contract.

## 4. Защита от инъекций в модуле

1. SQL только параметризованный.
2. Никакой динамической конкатенации SQL с пользовательским вводом.
3. Динамические сортировки/фильтры только через allow-list.
4. Пользовательские regex/сложные фильтры ограничивать по длине и сложности.
5. Ограничивать глубину вложенности сложных фильтров.

## 5. Логирование и redaction в модуле

1. Логировать только нужные поля для диагностики.
2. Перед логированием применять redaction.
3. Сохранять `correlation-id` для трассировки.
4. Не раскрывать чувствительные доменные детали в ошибках/логах доступа.

## 6. Ошибки модуля

1. Использовать единый формат ошибки.
2. Не отдавать stacktrace и внутренние детали SQL/хранилища.
3. Для типовых отказов использовать стабильные `code`.

## 7. Взаимодействие с app-level защитой

Модуль предполагает, что приложение уже обеспечило:
1. первичную валидацию входа;
2. auth middleware;
3. rate limit / ban / базовую DoS-защиту.

Если модулю кажется, что app-level защиты не хватает, он не внедряет "свою систему",
а поднимает изменение в общий app-level слой.

## 8. Проверка модуля (чек-лист)

1. `:auth/user` отсутствует или не имеет минимального `shape` -> корректный отказ без аварии.
2. Невалидные доменные данные отвергаются до записи в БД.
3. SQL-инъекционный ввод не меняет поведение запросов.
4. Сложные фильтры/regex не приводят к деградации или обходу ограничений.
5. Ошибки модуля соответствуют единому error-contract.
6. В логах модуля нет секретов.
7. В логах модуля сохраняется `correlation-id`.

## 9. Рекомендуемый toolchain (стабильные библиотеки)

1. Доменная валидация:
- `metosin/malli`.

2. Безопасная работа с SQL:
- `next.jdbc` (параметризованные запросы);
- `seancorfield/honeysql` (для динамически строящихся SQL).

3. Логирование и redaction:
- использовать общий app-level redaction middleware/функции, не изобретать модульные варианты.
